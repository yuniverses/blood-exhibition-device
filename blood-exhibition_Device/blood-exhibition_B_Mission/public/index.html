<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bå€ - æè¡€ç·Šæ€¥ä»»å‹™ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: #000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* å½±ç‰‡å®¹å™¨ */
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* é è¨­ç‹€æ…‹ */
        .idle-state {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2;
            background: linear-gradient(45deg, #dc2626, #ef4444);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .idle-state.hidden {
            display: none;
        }

        .idle-title {
            font-size: 5em;
            color: white;
            font-weight: 300;
            letter-spacing: 8px;
            animation: fadeInOut 3s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* ç·Šæ€¥ä»»å‹™ç‹€æ…‹ */
        .mission-state {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: none;
        }

        .mission-state.active {
            display: block;
        }

        /* æ–‡å­—ç–ŠåŠ å±¤ */
        .text-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 11;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.7) 100%);
        }

        .mission-alert {
            background: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 30px 60px;
            border-radius: 20px;
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 40px;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 10px 50px rgba(220, 38, 38, 0.5);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .mission-content {
            background: rgba(0, 0, 0, 0.85);
            padding: 60px;
            border-radius: 30px;
            max-width: 1200px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .mission-title {
            font-size: 4em;
            color: #fff;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .mission-description {
            font-size: 2.5em;
            color: #fff;
            line-height: 1.6;
            margin-bottom: 40px;
        }

        .patient-info {
            font-size: 2.8em;
            color: #fca5a5;
            margin-bottom: 30px;
        }

        .blood-type-needed {
            display: inline-block;
            background: white;
            color: #dc2626;
            padding: 30px 80px;
            border-radius: 50px;
            font-size: 5em;
            font-weight: bold;
            margin: 30px 0;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.3);
        }

        .scan-instruction {
            font-size: 2.5em;
            color: #fbbf24;
            margin-top: 40px;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .countdown {
            position: absolute;
            top: 40px;
            right: 40px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 50%;
            font-size: 3em;
            font-weight: bold;
            min-width: 120px;
            min-height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 30px rgba(239, 68, 68, 0.5);
        }

        /* çµæœç‹€æ…‹ */
        .result-state {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 20;
            display: none;
        }

        .result-state.active {
            display: block;
        }

        .result-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 21;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 80px;
        }

        .result-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
        }

        .result-failed {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
        }

        .result-icon {
            font-size: 10em;
            margin-bottom: 40px;
            animation: bounceIn 0.8s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .result-title {
            font-size: 5em;
            color: white;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .result-message {
            font-size: 3em;
            color: white;
            text-align: center;
            line-height: 1.6;
            max-width: 1000px;
        }

        .donor-name {
            font-size: 4em;
            color: #fef3c7;
            font-weight: bold;
            margin: 30px 0;
        }

        /* æ¸¬è©¦æŒ‰éˆ• */
        .test-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .test-btn {
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .test-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* QR Code è¼¸å…¥å€ */
        .qr-input-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            display: none;
        }

        .qr-input-panel.active {
            display: block;
        }

        .qr-input-panel input {
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #dc2626;
            border-radius: 10px;
            width: 300px;
            margin-right: 10px;
        }

        .qr-input-panel button {
            padding: 15px 30px;
            font-size: 1.2em;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .qr-input-panel button:hover {
            background: #ef4444;
        }

        /* éš±è—é¡ */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- é è¨­ç‹€æ…‹ -->
    <div class="idle-state" id="idleState">
        <h1 class="idle-title">æè¡€æ•‘äºº</h1>
    </div>

    <!-- ç·Šæ€¥ä»»å‹™ç‹€æ…‹ -->
    <div class="mission-state" id="missionState">
        <div class="video-container">
            <video id="missionVideo" muted></video>
        </div>
        <div class="text-overlay">
            <div class="countdown" id="countdown">30</div>
            <div class="mission-alert">ğŸš¨ ç·Šæ€¥ä»»å‹™ ğŸš¨</div>
            <div class="mission-content">
                <h2 class="mission-title" id="missionTitle">è»Šç¦æ€¥æ•‘</h2>
                <p class="mission-description" id="missionDescription">
                    ä¸€åæ©Ÿè»Šé¨å£«åœ¨å¸‚å€ç™¼ç”Ÿè»Šç¦ï¼Œå‚·å‹¢åš´é‡ï¼Œæ€¥éœ€å¤§é‡è¼¸è¡€ï¼
                </p>
                <p class="patient-info">
                    æ‚£è€…ï¼š<span id="patientName">ç‹å…ˆç”Ÿ</span>
                </p>
                <div class="blood-type-needed" id="bloodTypeNeeded">A+</div>
                <p class="scan-instruction">
                    â¬‡ï¸ è«‹æƒææ‚¨çš„ QR Code åƒèˆ‡æ•‘æ´ â¬‡ï¸
                </p>
            </div>
        </div>
    </div>

    <!-- çµæœç‹€æ…‹ -->
    <div class="result-state" id="resultState">
        <div class="video-container">
            <video id="resultVideo" muted></video>
        </div>
        <div class="result-overlay" id="resultOverlay">
            <div class="result-icon" id="resultIcon">âœ“</div>
            <h2 class="result-title" id="resultTitle">è¡€å‹ç¬¦åˆï¼</h2>
            <div class="donor-name">è¬è¬ <span id="donorName">ç‹å°æ˜</span> ä¾†æè¡€ï¼</div>
            <p class="result-message" id="resultMessage">
                æ‚¨çš„è¡€æ¶²å°‡æ‹¯æ•‘ç”Ÿå‘½ï¼Œè¬è¬æ‚¨çš„ç„¡ç§å¥‰ç»ï¼
            </p>
        </div>
    </div>

    <!-- æ¸¬è©¦æ§åˆ¶é¢æ¿ -->
    <div class="test-controls">
        <button class="test-btn" onclick="triggerMission()">è§¸ç™¼ä»»å‹™ (æ¸¬è©¦)</button>
        <button class="test-btn" onclick="toggleQRInput()">æ‰‹å‹•è¼¸å…¥ QR Code</button>
        <button class="test-btn" onclick="resetToIdle()">è¿”å›é è¨­ç‹€æ…‹</button>
    </div>

    <!-- QR Code è¼¸å…¥é¢æ¿ -->
    <div class="qr-input-panel" id="qrInputPanel">
        <input type="text" id="qrCodeInput" placeholder="è¼¸å…¥ç”¨æˆ¶ UUID">
        <button onclick="submitQRCode()">é€å‡º</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // ç‹€æ…‹ç®¡ç†
        const State = {
            IDLE: 'idle',
            MISSION: 'mission',
            RESULT: 'result'
        };

        let currentState = State.IDLE;
        let currentMission = null;
        let countdownTimer = null;
        let countdownValue = 30;

        // DOM å…ƒç´ 
        const idleState = document.getElementById('idleState');
        const missionState = document.getElementById('missionState');
        const resultState = document.getElementById('resultState');
        const missionVideo = document.getElementById('missionVideo');
        const resultVideo = document.getElementById('resultVideo');
        const qrInputPanel = document.getElementById('qrInputPanel');

        // åˆ‡æ›ç‹€æ…‹
        function switchState(newState) {
            console.log('åˆ‡æ›ç‹€æ…‹:', currentState, '->', newState);
            currentState = newState;

            idleState.classList.toggle('hidden', newState !== State.IDLE);
            missionState.classList.toggle('active', newState === State.MISSION);
            resultState.classList.toggle('active', newState === State.RESULT);

            if (newState === State.IDLE) {
                stopCountdown();
                qrInputPanel.classList.remove('active');
            }
        }

        // è§¸ç™¼ç·Šæ€¥ä»»å‹™
        async function triggerMission() {
            try {
                const response = await fetch('/api/mission/random');
                const data = await response.json();

                if (data.success) {
                    showMission(data.data);
                }
            } catch (error) {
                console.error('è§¸ç™¼ä»»å‹™å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºä»»å‹™
        function showMission(mission) {
            currentMission = mission;

            document.getElementById('missionTitle').textContent = mission.title;
            document.getElementById('missionDescription').textContent = mission.description;
            document.getElementById('patientName').textContent = mission.patientName;
            document.getElementById('bloodTypeNeeded').textContent = mission.requiredBloodType;

            // é€™è£¡æ‡‰è©²è¼‰å…¥å°æ‡‰çš„å½±ç‰‡ï¼Œä½†ç”±æ–¼æ²’æœ‰å¯¦éš›å½±ç‰‡æª”æ¡ˆï¼Œæˆ‘å€‘å…ˆç•¥é
            // missionVideo.src = `/videos/${mission.videoFile}`;
            // missionVideo.play();

            switchState(State.MISSION);
            startCountdown();
        }

        // é–‹å§‹å€’æ•¸è¨ˆæ™‚
        function startCountdown() {
            countdownValue = 30;
            updateCountdownDisplay();

            countdownTimer = setInterval(() => {
                countdownValue--;
                updateCountdownDisplay();

                if (countdownValue <= 0) {
                    stopCountdown();
                    resetToIdle();
                }
            }, 1000);
        }

        // åœæ­¢å€’æ•¸è¨ˆæ™‚
        function stopCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
        }

        // æ›´æ–°å€’æ•¸é¡¯ç¤º
        function updateCountdownDisplay() {
            document.getElementById('countdown').textContent = countdownValue;
        }

        // è™•ç† QR Code æƒæ
        async function handleQRScan(qrCode) {
            if (!currentMission) {
                console.error('æ²’æœ‰é€²è¡Œä¸­çš„ä»»å‹™');
                return;
            }

            stopCountdown();

            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        qrCode: qrCode,
                        missionId: currentMission.id
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showResult(data.data);
                } else {
                    alert('æƒæå¤±æ•—: ' + data.error);
                    resetToIdle();
                }
            } catch (error) {
                console.error('æƒæè™•ç†å¤±æ•—:', error);
                alert('æƒæè™•ç†å¤±æ•—: ' + error.message);
                resetToIdle();
            }
        }

        // é¡¯ç¤ºçµæœ
        function showResult(data) {
            const resultOverlay = document.getElementById('resultOverlay');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const donorName = document.getElementById('donorName');
            const resultMessage = document.getElementById('resultMessage');

            if (data.isCompatible) {
                // è¡€å‹ç¬¦åˆ
                resultOverlay.className = 'result-overlay result-success';
                resultIcon.textContent = 'âœ“';
                resultTitle.textContent = 'è¡€å‹ç¬¦åˆï¼';
                donorName.textContent = data.user.username;
                resultMessage.textContent = `æ‚¨çš„ ${data.user.bloodType} è¡€æ¶²å°‡æ‹¯æ•‘ ${data.mission.patientName} çš„ç”Ÿå‘½ï¼Œè¬è¬æ‚¨çš„ç„¡ç§å¥‰ç»ï¼`;

                // è¼‰å…¥æˆåŠŸå½±ç‰‡
                // resultVideo.src = '/videos/success.mp4';
            } else {
                // è¡€å‹ä¸åˆ
                resultOverlay.className = 'result-overlay result-failed';
                resultIcon.textContent = 'âœ—';
                resultTitle.textContent = 'è¡€å‹ä¸åˆ';
                donorName.textContent = data.user.username;
                resultMessage.textContent = `æ„Ÿè¬ ${data.user.username} çš„ç†±å¿ƒï¼Œä½†æ‚¨çš„ ${data.user.bloodType} è¡€å‹ç„¡æ³•ç”¨æ–¼é€™æ¬¡æ•‘æ´ã€‚æ¯ä¸€ä»½æ„›å¿ƒéƒ½å¾ˆçè²´ï¼`;

                // è¼‰å…¥å¤±æ•—å½±ç‰‡
                // resultVideo.src = '/videos/failed.mp4';
            }

            switchState(State.RESULT);
            // resultVideo.play();

            // 5ç§’å¾Œè¿”å›é è¨­ç‹€æ…‹
            setTimeout(() => {
                resetToIdle();
            }, 8000);
        }

        // è¿”å›é è¨­ç‹€æ…‹
        function resetToIdle() {
            switchState(State.IDLE);
            currentMission = null;
            countdownValue = 30;
        }

        // Socket.IO äº‹ä»¶ç›£è½
        socket.on('newMission', (mission) => {
            showMission(mission);
        });

        socket.on('scanResult', (data) => {
            if (data.success) {
                showResult(data);
            }
        });

        // æ¸¬è©¦åŠŸèƒ½
        function toggleQRInput() {
            qrInputPanel.classList.toggle('active');
        }

        function submitQRCode() {
            const qrCode = document.getElementById('qrCodeInput').value.trim();
            if (qrCode) {
                handleQRScan(qrCode);
                document.getElementById('qrCodeInput').value = '';
                qrInputPanel.classList.remove('active');
            }
        }

        // ç›£è½éµç›¤è¼¸å…¥ï¼ˆç”¨æ–¼QR Codeæƒæå™¨ï¼‰
        let qrBuffer = '';
        let qrTimeout = null;

        document.addEventListener('keypress', (e) => {
            // æ¸…é™¤ä¹‹å‰çš„è¶…æ™‚
            if (qrTimeout) {
                clearTimeout(qrTimeout);
            }

            // Enter éµè¡¨ç¤ºæƒæå®Œæˆ
            if (e.key === 'Enter') {
                if (qrBuffer.length > 0 && currentState === State.MISSION) {
                    handleQRScan(qrBuffer);
                    qrBuffer = '';
                }
            } else {
                // ç´¯ç©æƒæçš„å­—ç¬¦
                qrBuffer += e.key;

                // è¨­ç½®è¶…æ™‚ï¼Œå¦‚æœ1ç§’å…§æ²’æœ‰æ–°å­—ç¬¦ï¼Œæ¸…ç©ºç·©è¡
                qrTimeout = setTimeout(() => {
                    qrBuffer = '';
                }, 1000);
            }
        });

        // è‡ªå‹•è§¸ç™¼ä»»å‹™ï¼ˆæ¸¬è©¦ç”¨ï¼‰
        // å¯ä»¥è¨­å®šéš¨æ©Ÿæ™‚é–“é–“éš”è§¸ç™¼ä»»å‹™
        function autoTriggerMission() {
            const minInterval = 30000; // 30ç§’
            const maxInterval = 120000; // 2åˆ†é˜
            const interval = Math.random() * (maxInterval - minInterval) + minInterval;

            setTimeout(() => {
                if (currentState === State.IDLE && Math.random() > 0.7) {
                    triggerMission();
                }
                autoTriggerMission();
            }, interval);
        }

        // å•Ÿå‹•è‡ªå‹•è§¸ç™¼ï¼ˆå–æ¶ˆè¨»è§£ä»¥å•Ÿç”¨ï¼‰
        // autoTriggerMission();

        // åˆå§‹åŒ–
        console.log('Bå€æè¡€ä»»å‹™ç³»çµ±å·²å•Ÿå‹•');
    </script>
</body>
</html>
